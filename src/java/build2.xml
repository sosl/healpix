<?xml version="1.0"?>
<project name="HEALPix build file" default="newall" basedir=".">
  <property name="lib" value="${basedir}/lib"/>
  <property name="classes" value="${basedir}/classes"/>
  <property name="dist" value="${basedir}/dist"/>
  <property name="src" value="${basedir}/src"/>
  <property name="docs" value="${basedir}/doc"/>
  <property name="junit.reports" value="${basedir}/reports/junit"/>
  <path id="classpath">
    <pathelement location="${classes}"/>
    <fileset dir="${lib}">
      <include name="*.jar"/>
    </fileset>
  </path>
  <target name="init" description="Initialize the build">
    <mkdir dir="${classes}"/>
    <mkdir dir="${dist}"/>
    <mkdir dir="${docs}"/>
  </target>
  <target name="clean" depends="" description="Clean the build">
    <delete dir="${classes}"/>
    <delete dir="${junit.reports}"/>
    <delete dir="${docs}"/>
  </target>
  <target name="newcompile_newcore" depends="init" description="Compile the new Java code">
    <echo>building </echo>
    <javac destdir="${classes}" source="1.5" includeAntRuntime="false"
      srcdir="${src}"
      includes="**/newcore/*.java" >
    </javac>
  </target>
  <target name="newcompile" depends="init" description="Compile the new Java code">
    <echo>building </echo>
    <javac destdir="${classes}" source="1.5" includeAntRuntime="false"
      srcdir="${src}"
      includes="**/newcore/**/*.java,**/newfits/**/*.java" >
      <classpath refid="classpath" />
    </javac>
  </target>
  <target name="newtest" depends="newcompile" description="Test the new Java code">
    <delete dir="${junit.reports}"/>
    <mkdir dir="${junit.reports}"/>
    <junit errorProperty="junit.failed" failureProperty="junit.failed" fork="yes"
      maxmemory="1g" printsummary="withOutAndErr" showoutput="yes">
      <classpath refid="classpath" />
      <formatter type="xml" usefile="true" />
      <batchtest todir="${junit.reports}">
        <fileset dir="${classes}" includes="**/newcore/test/*Test.class,**/newfits/test/*Test.class" />
      </batchtest>
    </junit>
    <junitreport todir="${junit.reports}">
      <fileset dir="${junit.reports}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${junit.reports}/html"/>
    </junitreport>
    <fail message="Test Cases Failed" if="junit.failed"/>
  </target>
  <target name="newdist" depends="clean,newcompile,newtest" description="Build the JAR file containing only new classes">
    <jar destfile="${dist}/jhealpixNew.jar">
      <fileset dir="${classes}" includes="**/newcore/*.class,**/newfits/*.class" />
    </jar>
  </target>
  <target name="newdistsmall" depends="clean,newcompile,newtest" description="Build the JAR file containing only new classes">
    <jar destfile="${dist}/jhealpixNewSmall.jar">
      <fileset dir="${classes}" includes="**/newcore/*.class" excludes="**/newcore/HealpixMap*.class" />
    </jar>
  </target>
  <target name="newdistsrc" depends="clean" description="Build the source JAR file containing only new classes">
    <jar destfile="${dist}/jhealpixNew_src.jar">
      <fileset dir="${src}" includes="**/newcore/**,**/newfits/**" />
    </jar>
  </target>
  <target name="newdocs" description="Create the Javadocs">
    <javadoc destdir="${docs}" failonerror="true" use="true"
      additionalparam='-breakiterator -public -quiet -tag copyright:a:"Copyright:" -link http://java.sun.com/j2se/1.5.0/docs/api -link http://download.java.net/media/java3d/javadoc/1.4.0'
      classpathref="classpath">
      <packageset dir="${src}" defaultexcludes="yes">
        <include name="**/newcore/" />
        <include name="**/newfits/" />
        <exclude name="**/doc-files/**" />
        <exclude name="**/test/**" />
      </packageset>
      <footer>"Built from revision ${svn.revision}"</footer>
    </javadoc>
  </target>
  <target name="newall" depends="newdist,newdistsmall,newdistsrc,newdocs" description="Do everything for the new library"/>
</project>
